#!/bin/bash

# hyprwhspr - Hyprland-optimized voice dictation application
# Main launcher script

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PACKAGE_ROOT="$(dirname "$SCRIPT_DIR")"

# Set environment variables
export HYPRWHSPR_ROOT="$PACKAGE_ROOT"
export PYTHONPATH="$PACKAGE_ROOT/lib:$PYTHONPATH"

# Find venv Python (for main app execution)
# Find venv Python (for main app execution)
# Prioritize local venv in the project directory (for development/local usage)
LOCAL_VENV_PYTHON="$PACKAGE_ROOT/.venv/bin/python"
XDG_VENV_PYTHON="${XDG_DATA_HOME:-$HOME/.local/share}/hyprwhspr/venv/bin/python"

if [ -f "$LOCAL_VENV_PYTHON" ]; then
    PYTHON_CMD="$LOCAL_VENV_PYTHON"
elif [ -f "$XDG_VENV_PYTHON" ]; then
    PYTHON_CMD="$XDG_VENV_PYTHON"
else
    # Fallback to system Python if venv doesn't exist
    PYTHON_CMD="python"
fi

# Help handling is now done by the python module
# Subcommands are now handled by the python module

# Set up CUDA library path if CUDA is installed
if [ -d "/opt/cuda" ]; then
  CUDA_LIB_DIRS=""
  [ -d "/opt/cuda/lib" ] && CUDA_LIB_DIRS="/opt/cuda/lib"
  [ -d "/opt/cuda/lib64" ] && CUDA_LIB_DIRS="${CUDA_LIB_DIRS:+$CUDA_LIB_DIRS:}/opt/cuda/lib64"
  
  if [ -n "$CUDA_LIB_DIRS" ]; then
    export LD_LIBRARY_PATH="${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}${CUDA_LIB_DIRS}"
  fi
fi

# Set up ROCm library path if ROCm is installed
if [ -d "/opt/rocm" ]; then
  ROCM_LIB_DIRS=""
  [ -d "/opt/rocm/lib" ] && ROCM_LIB_DIRS="/opt/rocm/lib"
  [ -d "/opt/rocm/lib64" ] && ROCM_LIB_DIRS="${ROCM_LIB_DIRS:+$ROCM_LIB_DIRS:}/opt/rocm/lib64"
  
  if [ -n "$ROCM_LIB_DIRS" ]; then
    export LD_LIBRARY_PATH="${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}${ROCM_LIB_DIRS}"
  fi
fi

# Run the application as a module
exec "$PYTHON_CMD" -m hyprwhspr "$@"
